import{GetMsg}from"./GetMsg-min.js";import{saveAs}from"./FileSaver-min.js";const ICalCalendar=require("ICalCalendar");var ical=new ICalCalendar({domain:"jwxt.scnu.edu.cn",timezone:"Asia/Hong_Kong",prodId:{company:"https://github.com/Okami-2;LXJ&CZL",product:"SCNU_jwxt_pdf2ics",language:"zh-CN"},url:"https://github.com/lraty-li/SCNU-Jwxt-Pdf2Ics"});ical.clear();var Day=new Date,pdfjsLib=window["pdfjs-dist/build/pdf"],pdfjsLibHome="./Resource/pdfjs-2.6.347-dist/",SortedData={};function UpLoadFile(){var e=document.getElementById("UpLoadFileInput");if(0!==e.files.length)if("application/pdf"===e.files[0].type){var t=parseInt(document.getElementById("AlarmSelect").value),a={"星期一":"MO","星期二":"TU","星期三":"WE","星期四":"TH","星期五":"FR","星期六":"SA","星期日":"SU"},r={StoneBrand:["","8:30","9:20","10:20","11:10","14:30","15:20","16:10","17:00","19:00","19:50","20:40","21:30"],"BigLearnCity&SouthSea":["","8:30","9:20","10:20","11:10","14:00","14:50","15:40","16:30","19:00","19:50","20:40","21:30"]}[document.getElementById("CampusSelect").value],n=parseInt(document.getElementById("rangeInput").value);SortedData.Class.forEach((e=>{var s=r[parseInt(e.Time.split("-")[0])].split(":"),i=r[parseInt(e.Time.split("-")[1])].split(":");[...e.Detail.matchAll(/(\d+)-(\d+)周/g)].forEach((r=>{var o=parseInt(r[2])-parseInt(r[1])+1,l=parseInt(r[1])-n;l>=0&&(l-=1),(Day=new Date).setDate(Day.getDate()-Day.getDay()+1+7*l),Day.setHours(parseInt(s[0]),parseInt(s[1]),0);var d=Day.toISOString();Day.setHours(parseInt(i[0]),parseInt(i[1]),0),Day.setMinutes(Day.getMinutes()+40);var p=Day.toISOString();Day.setDate(Day.getDate()+7*o-1),ical.events([{start:d,end:p,summary:e.Class,description:e.Detail,location:e.Detail.match(/地点: .*?\s/)[0],organizer:{email:"example@example.com",name:"教师:"+e.Detail.match(/教师: .*?\s/)[0]},repeating:{freq:"WEEKLY",until:Day,byDay:a[e.Week]},alarms:[{type:"display",trigger:60*t}]}])}))})),saveAs(ical.toBlob(),e.files[0].name+".ics")}else alert("不是pdf文件哦。");else alert("没选到文件哦。")}pdfjsLib.GlobalWorkerOptions.workerSrc=pdfjsLibHome+"build/pdf.worker.js",document.getElementById("UpLoadFileInput").onchange=function(e){var t=e.target.files[0],a=new FileReader;a.onload=function(){var e=new Uint8Array(this.result);pdfjsLib.getDocument({data:e,cMapUrl:pdfjsLibHome+"/cmaps/",cMapPacked:!0}).promise.then((e=>{e.getPage(1).then((function(e){var t=[],a=e.getViewport({scale:2});e.getTextContent({normalizeWhitespace:!0}).then((e=>{e.items.forEach((function(e){let r=pdfjsLib.Util.transform(a.transform,e.transform);t.push({x:r[4],y:r[5],str:e.str})})),SortedData=GetMsg(t)}));var r=document.getElementById("pdfCanvas"),n=r.getContext("2d");r.height=a.height,r.width=a.width;var s={canvasContext:n,viewport:a};e.render(s).promise.then((function(){}))}))}))},a.readAsArrayBuffer(t)},document.querySelector("button").addEventListener("click",UpLoadFile);